### **Что такое UNION?**

**UNION** - это оператор SQL, который позволяет объединять результаты двух или более запросов **вертикально** (столбцы должны совпадать).

**Простая аналогия:** Представьте, что у вас есть два списка студентов из разных групп, и вы хотите сделать один общий список.

---

### **Базовый синтаксис**

```sql

SELECT столбец1, столбец2 FROM таблица1
UNION
SELECT столбец1, столбец2 FROM таблица2
```

---

### **Пример 1: Объединение клиентов из двух филиалов**

**Создадим тестовые таблицы:**

```sql

-- Клиенты первого филиала
CREATE TABLE Clients_Branch1 (
    ClientID INT,
    Name VARCHAR(50),
    City VARCHAR(50)
);

-- Клиенты второго филиала  
CREATE TABLE Clients_Branch2 (
    ClientID INT,
    Name VARCHAR(50),
    City VARCHAR(50)
);

-- Заполняем данными
INSERT INTO Clients_Branch1 VALUES 
(1, 'Иван Петров', 'Москва'),
(2, 'Мария Сидорова', 'Санкт-Петербург'),
(3, 'Алексей Козлов', 'Москва');

INSERT INTO Clients_Branch2 VALUES 
(4, 'Елена Волкова', 'Казань'),
(5, 'Дмитрий Орлов', 'Москва'), 
(2, 'Мария Сидорова', 'Санкт-Петербург'); -- Дубликат!
```

**Теперь выполним UNION:**

```sql

SELECT Name, City FROM Clients_Branch1
UNION
SELECT Name, City FROM Clients_Branch2;
```

**Что происходит построчно:**

1. **`SELECT Name, City FROM Clients_Branch1`** - выполняем первый запрос
    - Результат:
```text
    
    Иван Петров      Москва
    Мария Сидорова   Санкт-Петербург  
    Алексей Козлов   Москва
```
    
2. **`UNION`** - ключевое слово, которое говорит SQL Server: "А теперь объедини результат следующего запроса с тем, что получилось выше"
    
3. **`SELECT Name, City FROM Clients_Branch2`** - выполняем второй запрос
    - Результат:
```text
    
    Елена Волкова    Казань
    Дмитрий Орлов    Москва
    Мария Сидорова   Санкт-Петербург
```
    
4. **SQL Server автоматически:**
    
    - Объединяет все строки
    - **Удаляет дубликаты** (Мария Сидорова встречалась в обоих таблицах)
    - Сортирует результат (не всегда, но часто)

**Итоговый результат:**

```text

Алексей Козлов     Москва
Дмитрий Орлов      Москва
Елена Волкова      Казань
Иван Петров        Москва
Мария Сидорова     Санкт-Петербург
```

---

### **Важное правило №1: Совместимость столбцов**

Столбцы в `SELECT` должны быть **совместимы по типам данных и количеству**.

**ПРАВИЛЬНО:**

```sql

SELECT Name, City FROM Table1  -- 2 столбца: текст, текст
UNION
SELECT Name, City FROM Table2  -- 2 столбца: текст, текст
```

**НЕПРАВИЛЬНО:**

```sql

SELECT Name, City FROM Table1  -- 2 столбца
UNION  
SELECT Name FROM Table2        -- 1 столбец - ОШИБКА!
```

**НЕПРАВИЛЬНО:**

```sql

SELECT Name, Age FROM Table1   -- текст, число
UNION
SELECT Name, City FROM Table2  -- текст, текст - ОШИБКА!
```

---

### **UNION vs UNION ALL - в чем разница?**

#### **UNION (удаляет дубликаты)**

```sql

SELECT Product FROM Current_Products
UNION
SELECT Product FROM New_Products;
```

**Как работает:**

1. Выполняет оба запроса
2. Объединяет все строки
3. **Удаляет повторяющиеся строки**
4. Возвращает уникальные значения

**Пример:**

```sql

-- Таблица 1: Яблоко, Банан, Апельсин
-- Таблица 2: Банан, Киви, Груша

-- Результат UNION: Яблоко, Банан, Апельсин, Киви, Груша
-- (Банан из второй таблицы удален как дубликат)
```

#### **UNION ALL (сохраняет все записи)**

```sql

SELECT Product FROM Current_Products
UNION ALL
SELECT Product FROM New_Products;
```

**Как работает:**

1. Выполняет оба запроса
2. **Просто соединяет результаты** один под другим
3. Не проверяет дубликаты
4. Работает быстрее, так как не нужна сортировка для удаления дубликатов

**Пример:**

```sql

-- Таблица 1: Яблоко, Банан, Апельсин  
-- Таблица 2: Банан, Киви, Груша

-- Результат UNION ALL: Яблоко, Банан, Апельсин, Банан, Киви, Груша
-- (Все записи сохранены, включая дубликат "Банан")
```

---

### **Практический пример: Когда что использовать?**

**Сценарий 1: Нужен общий список email-адресов для рассылки (дубликаты не нужны)**

```sql

SELECT Email FROM Customers
UNION
SELECT Email FROM Newsletter_Subscribers
-- Удалит дубликаты - один человек не получит два одинаковых письма
```

**Сценарий 2: Статистика - сколько всего заказов было за два периода**

```sql

SELECT OrderID, OrderDate FROM Orders_2023
UNION ALL
SELECT OrderID, OrderDate FROM Orders_2024
-- Сохранит все заказы, даже если есть дубликаты (маловероятно)
-- Быстрее чем UNION
```

---

### **Пример 2: Объединение из одной таблицы с разными условиями**

```sql

-- Все клиенты из Москвы или Санкт-Петербурга
SELECT Name, City FROM Clients_Branch1 WHERE City = 'Москва'
UNION
SELECT Name, City FROM Clients_Branch1 WHERE City = 'Санкт-Петербург'
```

Это эквивалентно:

```sql

SELECT Name, City FROM Clients_Branch1 
WHERE City IN ('Москва', 'Санкт-Петербург')
```

Но UNION полезен, когда условия сложные или данные из разных источников.

---

### **Пример 3: Объединение с разными столбцами (но совместимыми)**

```sql

-- Можно объединять разные столбцы, если они совместимы
SELECT Name, City FROM Employees  -- Имя и город сотрудников
UNION
SELECT ProductName, Category FROM Products  -- Название и категория товаров
```

Результат будет содержать два столбца со смешанными данными разных типов.

---

### **Сортировка результатов UNION**

**ORDER BY всегда ставится в КОНЦЕ всего запроса:**

```sql

SELECT Name, City FROM Clients_Branch1
UNION
SELECT Name, City FROM Clients_Branch2
ORDER BY City, Name;  -- Сначала сортировка по городу, потом по имени
```

**НЕПРАВИЛЬНО:**

```sql

SELECT Name, City FROM Clients_Branch1 ORDER BY Name  -- ОШИБКА!
UNION
SELECT Name, City FROM Clients_Branch2;
```

---

### **Объединение трех и более запросов**

```sql

SELECT Name, City FROM Branch1
UNION
SELECT Name, City FROM Branch2  
UNION
SELECT Name, City FROM Branch3
UNION
SELECT Name, City FROM Branch4
ORDER BY City;
```
